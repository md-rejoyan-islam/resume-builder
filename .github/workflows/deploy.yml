name: Deploy to VPS Hosting

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      # 3. Install pnpm globally
      - name: Install pnpm
        run: npm install -g pnpm@9

      # 4. Verify pnpm
      - name: Check pnpm version
        run: pnpm -v

      # 5. Create .env files for client and server on runner
      - name: Create .env files
        env:
          ENV_FILE_CLIENT: ${{ secrets.ENV_FILE_CLIENT }}
          ENV_FILE_SERVER: ${{ secrets.ENV_FILE_SERVER }}
        run: |
          echo "${ENV_FILE_CLIENT}" > ./client/.env
          echo "Client .env created."
          echo "${ENV_FILE_SERVER}" > ./server/.env
          echo "Server .env created."

      # 6. Install dependencies and build client/server on runner
      - name: Install dependencies and build
        run: |
          pnpm install --no-frozen-lockfile
          pnpm run build

      # 7. Copy client to VPS
      - name: Copy client folder to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          source: "client/**"
          target: "/home/apps"

      # 8. Copy server to VPS
      - name: Copy server folder to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          source: "server/**"
          target: "/home/apps"

      # 9. SSH into VPS to install dependencies, start/reload PM2, reload Nginx
      - name: Deploy on VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          script: |
            # Add Node.js to PATH
            export PATH=/root/.nvm/versions/node/v24.11.1/bin:$PATH

            # Function to deploy project
            deploy_project() {
              DIR=$1
              NAME=$2

              cd "$DIR"

              # Install dependencies if not installed
              if ! command -v pnpm &> /dev/null; then
                npm install -g pnpm@9
              fi
              pnpm install || true

              # Start/reload PM2
              if pm2 list | grep -q "$NAME"; then
                pm2 reload $NAME
              else
                pm2 start npm --name "$NAME" -- start
              fi
            }

            # Deploy client
            deploy_project "/home/apps/client" "client"

            # Deploy server
            deploy_project "/home/apps/server" "server"

            # Reload Nginx
            sudo systemctl reload nginx
